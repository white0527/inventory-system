<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¥¥æ˜“é›¢ç·šæŸ¥åƒ¹ç³»çµ±</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --ios-bg: #F2F2F7; --ios-blue: #007AFF; --ios-card: #FFFFFF; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--ios-bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--ios-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; transition: 0.3s; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; background: var(--ios-blue); color: white; border: none; font-size: 18px; font-weight: bold; }

        /* é ‚éƒ¨èˆ‡å…§å®¹ */
        .nav-bar { background: rgba(255,255,255,0.9); height: 60px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-bottom: 1px solid #ddd; }
        .content { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 100px; }
        
        /* æœå°‹æ¡† */
        .search-wrapper { background: #E5E5EA; border-radius: 10px; height: 44px; display: flex; align-items: center; padding: 0 12px; }
        .search-input { border: none; background: transparent; font-size: 17px; width: 100%; outline: none; height: 100%; }

        /* å•†å“å¡ç‰‡ */
        .ios-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none; }
        .p-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .p-code { background: #eee; padding: 2px 8px; border-radius: 4px; font-size: 12px; color: #555; }
        .info-row { display: flex; justify-content: space-between; margin-top: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .price-val { font-size: 20px; font-weight: bold; }
        .cost-val { color: orange; filter: blur(5px); cursor: pointer; }

        /* åŠŸèƒ½é¸å–® */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: white; padding: 20px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav { background: white; border-top: 1px solid #ccc; height: 80px; display: flex; justify-content: space-around; padding-top: 10px; position: fixed; bottom: 0; width: 100%; }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 10px; }
        .nav-btn i { font-size: 24px; margin-bottom: 4px; }
        .nav-btn.active { color: var(--ios-blue); }

        /* ç‹€æ…‹åˆ— (é¡¯ç¤ºé›¢ç·š/é€£ç·š) */
        .status-bar { font-size: 12px; text-align: center; padding: 5px; color: #666; background: #eee; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: #007AFF; margin-bottom: 30px;"><i class="fas fa-cubes"></i> ç¥¥æ˜“é›¢ç·šç‰ˆ</h1>
        <input type="text" id="login-user" class="login-input" placeholder="å¸³è™Ÿ">
        <input type="password" id="login-pass" class="login-input" placeholder="å¯†ç¢¼">
        <button class="login-btn" onclick="performLogin()">ç™»å…¥ä¸¦ä¸‹è¼‰è³‡æ–™</button>
        <p style="margin-top:20px; color:gray; font-size:12px;">ç™»å…¥æ™‚éœ€é€£ç¶²ï¼Œä¹‹å¾Œå¯é›¢ç·šä½¿ç”¨</p>
    </div>

    <div id="main-app" style="display:none; height: 100vh; flex-direction: column;">
        <div class="nav-bar">ç¥¥æ˜“æŸ¥åƒ¹ <span id="data-count" style="font-size:12px; color:gray; margin-left:10px;">(0ç­†)</span></div>
        <div class="status-bar" id="sync-status">ç­‰å¾…è³‡æ–™åŒæ­¥...</div>

        <div id="view-search" class="content">
            <div class="search-wrapper">
                <i class="fas fa-search" style="color:gray; margin-right:10px;"></i>
                <input type="text" id="keyword" class="search-input" placeholder="è¼¸å…¥ä»£è™Ÿæˆ–åç¨± (å³æ™‚æœå°‹)" oninput="searchLocal()">
            </div>

            <div id="result-list">
                </div>
            
            <div id="empty-hint" style="text-align:center; color:#999; margin-top:50px;">
                <i class="fas fa-bolt" style="font-size:40px; margin-bottom:10px;"></i><br>è¼¸å…¥é—œéµå­—ï¼Œæ¥µé€ŸæŸ¥åƒ¹
            </div>
        </div>

        <div id="view-menu" class="content" style="display:none;">
            <div class="menu-grid">
                <div class="menu-item" onclick="syncData()">
                    <i class="fas fa-sync" style="color: #007AFF; font-size: 30px;"></i>
                    <span>æ‰‹å‹•æ›´æ–°è³‡æ–™</span>
                    <span style="font-size:10px; color:gray;">(éœ€é€£ç¶²)</span>
                </div>
                <div class="menu-item" onclick="downloadExcel()">
                    <i class="fas fa-file-export" style="color: #28a745; font-size: 30px;"></i>
                    <span>åŒ¯å‡º Excel (ä¿®æ”¹ç”¨)</span>
                </div>
                <div class="menu-item" onclick="triggerImport()">
                    <i class="fas fa-file-import" style="color: #e0a800; font-size: 30px;"></i>
                    <span>åŒ¯å…¥ Excel (æ›´æ–°åº«å­˜)</span>
                </div>
                <input type="file" id="excel-input" accept=".xlsx" style="display: none;" onchange="uploadExcel(this)">
            </div>
            <div style="margin-top:30px; padding:15px; background:white; border-radius:12px; font-size:14px; line-height:1.6; color:#555;">
                <strong>ğŸ”§ å¦‚ä½•ä¿®æ”¹è³‡æ–™ï¼Ÿ</strong><br>
                1. é»æ“Šã€ŒåŒ¯å‡º Excelã€ã€‚<br>
                2. ç”¨æ‰‹æ©Ÿæˆ–é›»è…¦ä¿®æ”¹å…§å®¹ (æ–°å¢é …ç›®/æ”¹åƒ¹æ ¼)ã€‚<br>
                3. é»æ“Šã€ŒåŒ¯å…¥ Excelã€ä¸Šå‚³å›ç³»çµ±ã€‚<br>
                4. ç³»çµ±æœƒè‡ªå‹•æ›´æ–° Supabaseï¼Œä¸¦åŒæ­¥åˆ°æ‰‹æ©Ÿã€‚
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('view-search', this)"><i class="fas fa-search"></i>æŸ¥åƒ¹</button>
            <button class="nav-btn" onclick="switchTab('view-menu', this)"><i class="fas fa-cog"></i>ç®¡ç†</button>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æ”¹ç‚ºæ‚¨çš„ Render ç¶²å€ â˜…â˜…â˜…
        const API_BASE_URL = "https://xiangyi-system.onrender.com"; 

        let localProducts = []; // æ‰‹æ©Ÿè£¡çš„è³‡æ–™åº« (é›¢ç·šç”¨)

        // 1. ç™»å…¥ & åˆæ¬¡ä¸‹è¼‰
        async function performLogin() {
            const btn = document.querySelector('.login-btn');
            btn.innerText = "æ­£åœ¨ä¸‹è¼‰è³‡æ–™åº«...";
            btn.disabled = true;

            // æ¨¡æ“¬ç™»å…¥é©—è­‰ (ç°¡åŒ–ç‰ˆ)
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;

            if(u && p) {
                // ç™»å…¥æˆåŠŸï¼Œé–‹å§‹ä¸‹è¼‰å…¨éƒ¨è³‡æ–™
                await syncData();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
            } else {
                alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
                btn.innerText = "ç™»å…¥ä¸¦ä¸‹è¼‰è³‡æ–™";
                btn.disabled = false;
            }
        }

        // 2. [æ ¸å¿ƒåŠŸèƒ½] åŒæ­¥è³‡æ–™ (æŠŠé›²ç«¯è³‡æ–™æŠ“ä¸‹ä¾†å­˜æ‰‹æ©Ÿ)
        async function syncData() {
            const status = document.getElementById('sync-status');
            status.innerText = "ğŸ”„ æ­£åœ¨é€£ç·šé›²ç«¯æ›´æ–°è³‡æ–™...";
            status.style.background = "#fff3cd";

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/all`);
                if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
                
                const data = await response.json();
                
                // å­˜å…¥è®Šæ•¸
                localProducts = data;
                
                // å­˜å…¥æ‰‹æ©Ÿç¡¬ç¢Ÿ (LocalStorage)
                localStorage.setItem('xiangyi_products', JSON.stringify(data));
                localStorage.setItem('last_sync', new Date().toLocaleString());

                document.getElementById('data-count').innerText = `(${data.length}ç­†)`;
                status.innerText = `âœ… è³‡æ–™å·²æ›´æ–° (æœ€å¾ŒåŒæ­¥: ${new Date().toLocaleTimeString()})`;
                status.style.background = "#d4edda";
                
                // æ¸…ç©ºæœå°‹æ¬„
                document.getElementById('keyword').value = '';
                document.getElementById('result-list').innerHTML = '';

            } catch (e) {
                console.error(e);
                status.innerText = "âš ï¸ ç„¡æ³•é€£ç·šï¼Œä½¿ç”¨ä¸Šæ¬¡çš„é›¢ç·šè³‡æ–™";
                status.style.background = "#f8d7da";
                
                // è®€å–ä¸Šæ¬¡å­˜çš„è³‡æ–™
                const cached = localStorage.getItem('xiangyi_products');
                if (cached) {
                    localProducts = JSON.parse(cached);
                    document.getElementById('data-count').innerText = `(${localProducts.length}ç­† - é›¢ç·š)`;
                }
            }
        }

        // 3. [æ ¸å¿ƒåŠŸèƒ½] é›¢ç·šæœå°‹ (ä¸é€£ç¶²ï¼Œç›´æ¥æœæ‰‹æ©Ÿè¨˜æ†¶é«”)
        function searchLocal() {
            const key = document.getElementById('keyword').value.toUpperCase().trim();
            const list = document.getElementById('result-list');
            const hint = document.getElementById('empty-hint');
            
            list.innerHTML = '';
            
            if (!key) {
                hint.style.display = 'block';
                return;
            }
            hint.style.display = 'none';

            // ç¯©é¸è³‡æ–™ (æœå°‹ ä»£è™Ÿ æˆ– åç¨±)
            // ç‚ºäº†æ•ˆèƒ½ï¼Œæœ€å¤šé¡¯ç¤ºå‰ 20 ç­†
            const results = localProducts.filter(p => 
                (p.code && p.code.toUpperCase().includes(key)) || 
                (p.name && p.name.toUpperCase().includes(key))
            ).slice(0, 20);

            if (results.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æŸ¥ç„¡è³‡æ–™</div>';
                return;
            }

            // ç”¢ç”Ÿå¡ç‰‡ HTML
            results.forEach(p => {
                const html = `
                    <div class="ios-card" style="display:block; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between;">
                            <div>
                                <div class="p-title">${p.name}</div>
                                <span class="p-code">${p.code}</span>
                                <span class="p-code" style="background:#e3f2fd; color:#0d47a1;">${p.carModel || 'é€šç”¨'}</span>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; color:#888;">åº«å­˜</div>
                                <div style="font-size:24px; font-weight:bold; color:${p.stock > 0 ? 'black' : 'red'}">${p.stock || 0}</div>
                            </div>
                        </div>
                        <div class="info-row">
                            <span>å„²ä½: ${p.location || '--'}</span>
                        </div>
                        <div class="info-row">
                            <div style="text-align:center; flex:1;">
                                <div style="font-size:12px; color:#888;">æ•£å®¢åƒ¹</div>
                                <div class="price-val" style="color:#28a745;">$${p.priceRetail || 0}</div>
                            </div>
                            <div style="text-align:center; flex:1; border-left:1px solid #eee;">
                                <div style="font-size:12px; color:#888;">åŒæ¥­åƒ¹</div>
                                <div class="price-val" style="color:#007AFF;">$${p.pricePeer || 0}</div>
                            </div>
                            <div style="text-align:center; flex:1; border-left:1px solid #eee;" onclick="this.querySelector('.cost-val').style.filter='none'">
                                <div style="font-size:12px; color:#888;">æˆæœ¬ (é»æ“Š)</div>
                                <div class="cost-val">$${p.priceCost || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        // 4. Excel åŠŸèƒ½ (æ²¿ç”¨ä¹‹å‰çš„é‚è¼¯)
        async function downloadExcel() {
            if(!confirm("è¦åŒ¯å‡ºè³‡æ–™é€²è¡Œä¿®æ”¹å—ï¼Ÿ")) return;
            window.location.href = `${API_BASE_URL}/api/excel/export`;
        }

        function triggerImport() { document.getElementById('excel-input').click(); }

        async function uploadExcel(input) {
            if (input.files.length === 0) return;
            const formData = new FormData();
            formData.append("file", input.files[0]);
            alert("æ­£åœ¨ä¸Šå‚³ä¸¦æ›´æ–°è³‡æ–™åº«...");

            try {
                const response = await fetch(`${API_BASE_URL}/api/excel/import`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    alert("âœ… æ›´æ–°æˆåŠŸï¼\nç³»çµ±å°‡è‡ªå‹•é‡æ–°åŒæ­¥è³‡æ–™...");
                    await syncData(); // æ›´æ–°å®Œé¦¬ä¸ŠåŒæ­¥å›æ‰‹æ©Ÿ
                } else {
                    alert("âŒ å¤±æ•—ï¼š" + result.message);
                }
            } catch (e) {
                alert("ä¸Šå‚³éŒ¯èª¤");
            }
            input.value = '';
        }

        // UI åˆ‡æ›
        function switchTab(viewId, btn) {
            document.querySelectorAll('.content').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // è‡ªå‹•æª¢æŸ¥ï¼šå¦‚æœå·²ç¶“ç™»å…¥éï¼Œç›´æ¥é¡¯ç¤ºä¸»ç•«é¢ä¸¦å˜—è©¦èƒŒæ™¯æ›´æ–°
        if(localStorage.getItem('xiangyi_products')) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            localProducts = JSON.parse(localStorage.getItem('xiangyi_products'));
            document.getElementById('data-count').innerText = `(${localProducts.length}ç­† - é›¢ç·š)`;
            syncData(); // èƒŒæ™¯å·å·æ›´æ–°
        }
    </script>
</body>
</html>