<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¥¥æ˜“é›¢ç·šæŸ¥åƒ¹ç³»çµ±</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --ios-bg: #F2F2F7; --ios-blue: #007AFF; --ios-card: #FFFFFF; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--ios-bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* ç™»å…¥ç•«é¢ */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--ios-bg); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; transition: 0.3s; }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #ccc; font-size: 16px; }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; background: var(--ios-blue); color: white; border: none; font-size: 18px; font-weight: bold; }

        /* é ‚éƒ¨èˆ‡å…§å®¹ */
        .nav-bar { background: rgba(255,255,255,0.9); height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .logout-btn { background: none; border: none; color: #ef4444; font-size: 14px; cursor: pointer; font-weight: bold;}
        .content { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 15px; padding-bottom: 100px; }
        
        /* æœå°‹æ¡† */
        .search-wrapper { background: #E5E5EA; border-radius: 10px; height: 44px; display: flex; align-items: center; padding: 0 12px; }
        .search-input { border: none; background: transparent; font-size: 17px; width: 100%; outline: none; height: 100%; }

        /* å•†å“å¡ç‰‡ */
        .ios-card { background: white; border-radius: 12px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .p-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #1e293b; line-height: 1.4; }
        .p-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; font-size: 14px; color: #475569; }
        .p-code { background: #f1f5f9; padding: 4px 8px; border-radius: 6px; display: inline-block; font-family: monospace; }
        .p-model { color: #007AFF; font-weight: 500; }
        
        .price-section { display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 12px; text-align: center; }
        .price-box { flex: 1; border-right: 1px solid #eee; }
        .price-box:last-child { border-right: none; }
        .price-label { font-size: 11px; color: #888; margin-bottom: 4px; }
        .price-val { font-size: 18px; font-weight: bold; }
        .cost-val { color: #f59e0b; filter: blur(4px); cursor: pointer; transition: 0.3s; }
        .cost-val.revealed { filter: none; }

        /* åŠŸèƒ½é¸å–® */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: white; padding: 20px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav { background: white; border-top: 1px solid #ccc; height: 80px; display: flex; justify-content: space-around; padding-top: 10px; position: fixed; bottom: 0; width: 100%; }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 10px; width: 50%; }
        .nav-btn i { font-size: 24px; margin-bottom: 4px; }
        .nav-btn.active { color: var(--ios-blue); }

        .status-bar { font-size: 12px; text-align: center; padding: 5px; color: #666; background: #eee; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1 style="color: #007AFF; margin-bottom: 30px;"><i class="fas fa-cubes"></i> ç¥¥æ˜“æŸ¥åƒ¹ç³»çµ±</h1>
        <input type="text" id="login-user" class="login-input" placeholder="å¸³è™Ÿ">
        <input type="password" id="login-pass" class="login-input" placeholder="å¯†ç¢¼">
        <button class="login-btn" onclick="performLogin()">ç™»å…¥ç³»çµ±</button>
        <p style="margin-top:20px; color:gray; font-size:12px;">ç¬¬ä¸€æ¬¡ç™»å…¥éœ€é€£ç·šé©—è­‰</p>
    </div>

    <div id="main-app" style="display:none; height: 100vh; flex-direction: column;">
        <div class="nav-bar">
            <span>ç¥¥æ˜“æŸ¥åƒ¹ <span id="data-count" style="font-size:12px; color:gray; font-weight:normal;">(0ç­†)</span></span>
            <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
        </div>
        <div class="status-bar" id="sync-status">ç­‰å¾…è³‡æ–™åŒæ­¥...</div>

        <div id="view-search" class="content">
            <div class="search-wrapper">
                <i class="fas fa-search" style="color:gray; margin-right:10px;"></i>
                <input type="text" id="keyword" class="search-input" placeholder="è¼¸å…¥å•†å“ä»£è™Ÿã€åç¨±æˆ–è»Šç¨®" oninput="searchLocal()">
            </div>
            <div id="result-list"></div>
            <div id="empty-hint" style="text-align:center; color:#999; margin-top:50px;">
                <i class="fas fa-bolt" style="font-size:40px; margin-bottom:10px;"></i><br>è¼¸å…¥é—œéµå­—ï¼Œæ¥µé€ŸæŸ¥åƒ¹
            </div>
        </div>

        <div id="view-menu" class="content" style="display:none;">
            
            <h3 style="color:#333; margin-top:0;"><i class="fas fa-box"></i> åº«å­˜è³‡æ–™ç®¡ç†</h3>
            <div class="menu-grid">
                <div class="menu-item" onclick="syncData()">
                    <i class="fas fa-sync" style="color: #007AFF; font-size: 30px;"></i><span>æ‰‹å‹•æ›´æ–°è³‡æ–™</span>
                </div>
                <div class="menu-item" onclick="downloadExcel()">
                    <i class="fas fa-file-export" style="color: #28a745; font-size: 30px;"></i><span>åŒ¯å‡º Excel</span>
                </div>
                <div class="menu-item" onclick="triggerImport()" style="grid-column: span 2;">
                    <i class="fas fa-file-import" style="color: #e0a800; font-size: 30px;"></i><span>åŒ¯å…¥ Excel (æ›´æ–°åº«å­˜èˆ‡åƒ¹æ ¼)</span>
                </div>
                <input type="file" id="excel-input" accept=".xlsx" style="display: none;" onchange="uploadExcel(this)">
            </div>

            <hr style="margin: 25px 0; border: 0; border-top: 1px solid #ddd;">
            <h3 style="color:#333; margin-top:0;"><i class="fas fa-users"></i> å“¡å·¥å¸³è™Ÿç®¡ç†</h3>
            <div style="background:white; padding:15px; border-radius:12px; margin-bottom:15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-emp-user" placeholder="æ–°å¸³è™Ÿ" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <input type="text" id="new-emp-pass" placeholder="å¯†ç¢¼" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:8px;">
                    <button onclick="addEmployee()" style="background:#007AFF; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold; cursor:pointer;">æ–°å¢</button>
                </div>
                <div id="employee-list" style="font-size:14px;">
                    </div>
            </div>

        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('view-search', this)"><i class="fas fa-search"></i>æŸ¥åƒ¹</button>
            <button class="nav-btn" id="nav-btn-admin" onclick="switchTab('view-menu', this)"><i class="fas fa-cog"></i>ç®¡ç†</button>
        </div>
    </div>

    <script>
        const API_BASE_URL = "https://xiangyi-system.onrender.com"; 

        let localProducts = []; 
        let userRole = 'staff'; 

        // 1. ç™»å…¥é€£ç·šé©—è­‰ (å‘¼å«å¾Œç«¯è³‡æ–™åº«)
        async function performLogin() {
            const btn = document.querySelector('.login-btn');
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();

            if (!u || !p) { alert("è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼"); return; }

            btn.innerText = "é©—è­‰å¸³è™Ÿä¸­...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                
                const result = await res.json();
                
                if (result.success) {
                    userRole = result.role;
                    localStorage.setItem('xiangyi_role', userRole);
                    setupUIByRole();
                    
                    btn.innerText = "æ­£åœ¨ä¸‹è¼‰åº«å­˜...";
                    await syncData();
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                } else {
                    alert("âŒ " + result.message);
                    btn.innerText = "ç™»å…¥ç³»çµ±";
                    btn.disabled = false;
                }
            } catch (e) {
                alert("âš ï¸ é€£ç·šä¼ºæœå™¨å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–ç³»çµ±ç‹€æ…‹ï¼");
                btn.innerText = "ç™»å…¥ç³»çµ±";
                btn.disabled = false;
            }
        }

        // æ¬Šé™ UI æ§åˆ¶
        function setupUIByRole() {
            const adminNavBtn = document.getElementById('nav-btn-admin');
            if (userRole === 'staff') {
                adminNavBtn.style.display = 'none'; 
            } else {
                adminNavBtn.style.display = 'flex'; 
                loadEmployees(); // å¦‚æœæ˜¯è€é—†ï¼Œè‡ªå‹•è¼‰å…¥å“¡å·¥æ¸…å–®
            }
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                localStorage.removeItem('xiangyi_role');
                location.reload(); 
            }
        }

        // --- å¸³è™Ÿç®¡ç†åŠŸèƒ½ ---
        async function loadEmployees() {
            if(userRole !== 'boss') return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/users`);
                const users = await res.json();
                const list = document.getElementById('employee-list');
                list.innerHTML = '';
                
                users.forEach(u => {
                    const isBoss = u.role === 'boss';
                    const icon = isBoss ? 'ğŸ‘‘' : 'ğŸ‘¤';
                    const delBtn = isBoss ? '' : `<button onclick="deleteEmployee(${u.id})" style="color:#ef4444; background:none; border:none; padding:5px; font-size:16px; cursor:pointer;"><i class="fas fa-trash"></i></button>`;
                    
                    list.innerHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                            <div>${icon} å¸³è™Ÿ: <b>${u.username}</b> <span style="color:#888; font-size:12px; margin-left:10px;">å¯†ç¢¼: ${u.password}</span></div>
                            ${delBtn}
                        </div>`;
                });
            } catch(e) { console.error("ç„¡æ³•è¼‰å…¥å¸³è™Ÿæ¸…å–®"); }
        }

        async function addEmployee() {
            const u = document.getElementById('new-emp-user').value.trim();
            const p = document.getElementById('new-emp-pass').value.trim();
            if(!u || !p) { alert("è«‹è¼¸å…¥æ–°å¸³è™Ÿèˆ‡å¯†ç¢¼"); return; }
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const result = await res.json();
                if(result.success) {
                    alert("âœ… æ–°å¢æˆåŠŸ");
                    document.getElementById('new-emp-user').value = '';
                    document.getElementById('new-emp-pass').value = '';
                    loadEmployees();
                } else {
                    alert("âŒ " + result.message);
                }
            } catch(e) { alert("æ–°å¢å¤±æ•—"); }
        }

        async function deleteEmployee(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å¸³è™Ÿå—ï¼Ÿ(åˆªé™¤å¾Œè©²å“¡å·¥å°‡ç„¡æ³•ç™»å…¥)")) return;
            try {
                await fetch(`${API_BASE_URL}/api/users/${id}`, { method: 'DELETE' });
                loadEmployees();
            } catch(e) { alert("åˆªé™¤å¤±æ•—"); }
        }


        // --- åŸæœ¬çš„è³‡æ–™èˆ‡æœå°‹åŠŸèƒ½ ---
        async function syncData() {
            const status = document.getElementById('sync-status');
            status.innerText = "ğŸ”„ æ­£åœ¨é€£ç·šé›²ç«¯æ›´æ–°è³‡æ–™...";
            status.style.background = "#fff3cd";

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/all`);
                if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
                
                const data = await response.json();
                localProducts = data;
                localStorage.setItem('xiangyi_products', JSON.stringify(data));

                document.getElementById('data-count').innerText = `(${data.length}ç­†)`;
                status.innerText = `âœ… è³‡æ–™å·²æ›´æ–° (æœ€å¾ŒåŒæ­¥: ${new Date().toLocaleTimeString()})`;
                status.style.background = "#d4edda";
                
                document.getElementById('keyword').value = '';
                document.getElementById('result-list').innerHTML = '';

            } catch (e) {
                status.innerText = "âš ï¸ ç„¡æ³•é€£ç·šï¼Œä½¿ç”¨ä¸Šæ¬¡çš„é›¢ç·šè³‡æ–™";
                status.style.background = "#f8d7da";
                const cached = localStorage.getItem('xiangyi_products');
                if (cached) {
                    localProducts = JSON.parse(cached);
                    document.getElementById('data-count').innerText = `(${localProducts.length}ç­† - é›¢ç·š)`;
                }
            }
        }

        function searchLocal() {
            const key = document.getElementById('keyword').value.toUpperCase().trim();
            const list = document.getElementById('result-list');
            const hint = document.getElementById('empty-hint');
            
            list.innerHTML = '';
            
            if (!key) {
                hint.style.display = 'block';
                return;
            }
            hint.style.display = 'none';

            const results = localProducts.filter(p => 
                (p.code && p.code.toUpperCase().includes(key)) || 
                (p.name && p.name.toUpperCase().includes(key)) ||
                (p.carModel && p.carModel.toUpperCase().includes(key))
            ).slice(0, 20);

            if (results.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æŸ¥ç„¡è³‡æ–™</div>';
                return;
            }

            results.forEach(p => {
                const stockColor = p.stock < 3 ? 'red' : 'black'; 
                let costHtml = '';
                if (userRole === 'boss') {
                    costHtml = `
                        <div class="price-box" onclick="this.querySelector('.cost-val').classList.toggle('revealed')">
                            <div class="price-label">è€é—†æˆæœ¬ (é»æ“Š)</div>
                            <div class="cost-val">$${p.priceCost || 0}</div>
                        </div>
                    `;
                }

                const html = `
                    <div class="ios-card">
                        <div class="p-title">${p.name}</div>
                        <div class="p-info-grid">
                            <div>ğŸ“¦ æ–™è™Ÿï¼š<span class="p-code">${p.code}</span></div>
                            <div>ğŸï¸ è»Šç¨®ï¼š<span class="p-model">${p.carModel || 'é€šç”¨'}</span></div>
                        </div>
                        
                        <div class="price-section">
                            <div class="price-box">
                                <div class="price-label">åº«å­˜é‡</div>
                                <div class="price-val" style="color: ${stockColor};">${p.stock || 0}</div>
                            </div>
                            <div class="price-box">
                                <div class="price-label">è»Šè¡ŒåŒæ¥­åƒ¹</div>
                                <div class="price-val" style="color: #007AFF;">$${p.pricePeer || 0}</div>
                            </div>
                            <div class="price-box">
                                <div class="price-label">é–€å¸‚é›¶å”®åƒ¹</div>
                                <div class="price-val" style="color: #28a745;">$${p.priceRetail || 0}</div>
                            </div>
                            ${costHtml}
                        </div>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        async function downloadExcel() {
            if(!confirm("è¦åŒ¯å‡ºè³‡æ–™é€²è¡Œä¿®æ”¹å—ï¼Ÿ")) return;
            window.location.href = `${API_BASE_URL}/api/excel/export`;
        }

        function triggerImport() { document.getElementById('excel-input').click(); }

        async function uploadExcel(input) {
            if (input.files.length === 0) return;
            const formData = new FormData();
            formData.append("file", input.files[0]);
            alert("æ­£åœ¨ä¸Šå‚³ä¸¦æ›´æ–°è³‡æ–™åº«...");

            try {
                const response = await fetch(`${API_BASE_URL}/api/excel/import`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    alert("âœ… æ›´æ–°æˆåŠŸï¼ç³»çµ±å°‡è‡ªå‹•é‡æ–°åŒæ­¥è³‡æ–™...");
                    await syncData(); 
                } else {
                    alert("âŒ å¤±æ•—ï¼š" + result.message);
                }
            } catch (e) {
                alert("ä¸Šå‚³éŒ¯èª¤");
            }
            input.value = '';
        }

        function switchTab(viewId, btn) {
            document.querySelectorAll('.content').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        window.onload = () => {
            const savedRole = localStorage.getItem('xiangyi_role');
            if(savedRole && localStorage.getItem('xiangyi_products')) {
                userRole = savedRole;
                setupUIByRole();
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                localProducts = JSON.parse(localStorage.getItem('xiangyi_products'));
                document.getElementById('data-count').innerText = `(${localProducts.length}ç­† - é›¢ç·š)`;
                syncData();
            }
        };
    </script>
</body>
</html>