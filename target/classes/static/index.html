<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>祥易機車材料 - 專業全能版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* === 核心配色 === */
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --text-dark: #1e293b;
            
            /* === 玻璃材質與陰影 === */
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --glass-border: rgba(0, 0, 0, 0.1);
            --grid-line: #cbd5e1;
            --shadow-float: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            overflow: hidden;
            color: var(--text-dark);
        }

        /* === 左側選單 === */
        .sidebar {
            width: 200px;
            background: #1e293b;
            color: #f1f5f9;
            display: flex;
            flex-direction: column;
            z-index: 20;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .logo-area {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            background: rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-menu { padding: 10px 0; list-style: none; margin: 0; overflow-y: auto; }
        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.2s;
            font-size: 14px;
            border-left: 4px solid transparent;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
            border-left-color: #3b82f6;
        }
        .nav-item i { width: 20px; text-align: center; }

        /* === 右側主畫面 === */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === 頂部功能導航列 === */
        .top-bar {
            height: 50px;
            background: rgba(255,255,255,0.8);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 8px;
            overflow-x: visible; 
            z-index: 50;
        }

        .top-pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
            background: rgba(255,255,255,0.6);
            white-space: nowrap;
        }
        .top-pill:hover { background: #eff6ff; color: var(--primary-color); }
        .top-pill.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        /* 下拉選單 */
        .dropdown-wrapper { position: relative; display: inline-block; }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 110%;
            left: 0;
            min-width: 200px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: var(--shadow-float);
            padding: 5px;
            z-index: 100;
        }
        .dropdown-wrapper.open .dropdown-menu { display: block; }
        .dropdown-item {
            display: block; padding: 8px 12px; color: #334155; font-size: 13px;
            border-radius: 5px; cursor: pointer;
        }
        .dropdown-item:hover { background: #eff6ff; color: var(--primary-color); }
        .dropdown-divider { height: 1px; background: #e2e8f0; margin: 4px 0; }

        /* === 工作區 === */
        .workspace {
            padding: 10px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
        }

        .panel-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* [上] 單頭 - 兩列佈局 */
        .form-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .header-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .form-group { display: flex; align-items: center; gap: 8px; }
        label { font-weight: bold; font-size: 14px; color: #475569; white-space: nowrap; }
        input.header-input {
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            width: 130px;
        }
        input.addr-input { width: 400px; } /* 地址欄位加長 */
        input.name-input { width: 180px; } /* 客戶名稱欄位 */

        /* [中] 表格 */
        .grid-wrapper {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--grid-line);
            background: #fff;
        }
        .grid-container { flex-grow: 1; overflow: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th {
            background: #eff6ff; color: #1e3a8a; padding: 8px 5px;
            border: 1px solid var(--grid-line); position: sticky; top: 0; z-index: 5;
            text-align: center; font-size: 13px; white-space: nowrap;
        }
        td {
            border: 1px solid var(--grid-line); padding: 0; height: 30px;
            font-size: 14px; color: #334155;
        }
        td input {
            width: 100%; height: 100%; border: none; background: transparent;
            padding: 0 5px; outline: none; text-align: center;
        }
        td input:focus { background: #fff; box-shadow: inset 0 0 0 2px var(--primary-color); }
        tr:nth-child(even) td { background: #f8fafc; }
        .price-col { background: #f0fdf4 !important; }

        /* [下] 單尾 */
        .footer-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            padding-top: 10px;
        }
        .btn-group { display: flex; gap: 8px; }
        .btn {
            padding: 6px 16px;
            border-radius: 4px;
            border: 1px solid transparent;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            display: flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        /* 按鈕顏色 */
        .btn-blue { background: #e0f2fe; color: #0284c7; border-color: #bae6fd; }
        .btn-blue:hover { background: #0284c7; color: white; }
        .btn-green { background: #dcfce7; color: #16a34a; border-color: #bbf7d0; }
        .btn-green:hover { background: #16a34a; color: white; }
        .btn-red { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .btn-red:hover { background: #dc2626; color: white; }
        .btn-gray { background: #f1f5f9; color: #475569; border-color: #cbd5e1; }
        .btn-gray:hover { background: #475569; color: white; }

        .price-select { border: none; background: transparent; font-weight: bold; color: #16a34a; cursor: pointer; outline: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-area">祥易機車材料</div>
        <ul class="nav-menu">
            <li class="nav-item active"><i class="fas fa-cash-register"></i> 1. 銷貨</li>
            <li class="nav-item"><i class="fas fa-truck-loading"></i> 2. 進貨</li>
            <li class="nav-item"><i class="fas fa-file-invoice-dollar"></i> 3. 結帳</li>
            <li class="nav-item"><i class="fas fa-tags"></i> 4. 標籤</li>
            <li class="nav-item"><i class="fas fa-boxes"></i> 5. 商品</li>
            <li class="nav-item"><i class="fas fa-users"></i> 6. 客戶</li>
            <li class="nav-item"><i class="fas fa-industry"></i> 7. 廠商</li>
            <li class="nav-item"><i class="fas fa-folder-open"></i> 8. 其他資料</li>
            <li class="nav-item"><i class="fas fa-database"></i> 9. 備份</li>
            <li class="nav-item"><i class="fas fa-sign-out-alt"></i> 0. 退出</li>
        </ul>
    </div>

    <div class="main-content">
        
        <div class="top-bar" id="sales-top-menu">
            <div class="top-pill active" onclick="switchSubTab(this, '0')">0. 門市現銷</div>
            <div class="top-pill" onclick="switchSubTab(this, '1')">1. 銷貨登記</div>
            <div class="top-pill" onclick="switchSubTab(this, '2')">2. 銷貨查詢</div>
            <div class="top-pill" onclick="switchSubTab(this, '3')">3. 瀏覽式查詢</div>
            
            <div style="width: 1px; height: 20px; background: #cbd5e1; margin: 0 5px;"></div>

            <div class="dropdown-wrapper" onclick="toggleDropdown(this)">
                <div class="top-pill">
                    A. 銷貨退貨 <i class="fas fa-chevron-down" style="margin-left:5px; font-size:10px;"></i>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="subAction('A-1')">1. 退貨登記</div>
                    <div class="dropdown-item" onclick="subAction('A-2')">2. 退貨查詢</div>
                    <div class="dropdown-item" onclick="subAction('A-3')">3. 瀏覽式退貨查詢</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="subAction('A-4')">4. 退貨統計</div>
                </div>
            </div>

            <div class="dropdown-wrapper" onclick="toggleDropdown(this)">
                <div class="top-pill">
                    B. 報價作業 <i class="fas fa-chevron-down" style="margin-left:5px; font-size:10px;"></i>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item" onclick="subAction('B-1')">1. 報價登記</div>
                    <div class="dropdown-item" onclick="subAction('B-2')">2. 報價查詢</div>
                </div>
            </div>

             <div class="dropdown-wrapper" onclick="toggleDropdown(this)">
                <div class="top-pill"><i class="fas fa-cog"></i> 其它設定</div>
                <div class="dropdown-menu">
                    <div class="dropdown-item">C. 設定出貨單格式</div>
                    <div class="dropdown-item">D. 出貨單列印位置</div>
                </div>
            </div>
        </div>

        <div class="workspace">
            
            <div style="padding-left:5px; font-size:16px; font-weight:bold; color:var(--primary-color);">
                <i class="fas fa-angle-right"></i> <span id="current-mode-title">門市現銷作業</span>
            </div>

            <div class="panel-box form-header">
                <div class="header-row">
                    <div class="form-group">
                        <label>編號</label>
                        <input type="text" class="header-input" value="自動生成" disabled style="background:#f1f5f9;">
                    </div>
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" class="header-input" id="sales-date">
                    </div>
                    <div class="form-group" style="background: #fffbeb; padding: 2px 5px; border-radius: 4px; border: 1px solid #fcd34d;">
                        <label>帳款月份</label>
                        <input type="month" class="header-input" id="billing-month">
                    </div>
                </div>

                <div class="header-row">
                    <div class="form-group">
                        <label>客戶代號</label>
                        <input type="text" class="header-input" id="sales-cust" placeholder="代號/掃描">
                    </div>
                    <div class="form-group">
                        <label>客戶名稱</label>
                        <input type="text" class="header-input name-input" id="sales-cust-name" placeholder="自動帶出名稱">
                    </div>
                    <div class="form-group">
                        <label>客戶地址</label>
                        <input type="text" class="header-input addr-input" id="sales-addr" placeholder="送貨地址">
                    </div>
                </div>
            </div>

            <div class="grid-wrapper panel-box">
                <div class="grid-container">
                    <table id="sales-table">
                        <thead>
                            <tr>
                                <th width="40">序</th>
                                <th width="120" style="color:#ef4444;">商品代號</th>
                                <th width="100">車種</th>
                                <th>商品名稱</th>
                                <th width="60">數量</th>
                                <th width="80">單價</th>
                                <th width="120" class="price-col">
                                    金額 (
                                    <select class="price-select" onchange="changePriceType(this)">
                                        <option value="retail">散客價</option>
                                        <option value="shop">車行價</option>
                                        <option value="vendor">廠商價</option>
                                    </select>
                                    )
                                </th>
                                <th width="100">備註</th>
                                <th width="80">儲位</th>
                            </tr>
                        </thead>
                        <tbody id="sales-list">
                            </tbody>
                    </table>
                </div>
            </div>

            <div class="panel-box footer-bar">
                <div class="form-group">
                    <label>製表人</label>
                    <input type="text" class="header-input" value="管理員" style="width:100px;">
                </div>
                <div class="btn-group">
                    <button class="btn btn-blue" onclick="editOrder()"><i class="fas fa-edit"></i> 修改</button>
                    <button class="btn btn-green" onclick="saveSales(true)"><i class="fas fa-print"></i> 存檔+印表</button>
                    <button class="btn btn-green" onclick="saveSales(false)"><i class="fas fa-save"></i> 存檔</button>
                    <button class="btn btn-red" onclick="clearOrder()"><i class="fas fa-trash-alt"></i> 刪除</button>
                    <button class="btn btn-blue" onclick="addSalesRow()"><i class="fas fa-plus"></i> 插入一行</button>
                    <button class="btn btn-gray" onclick="exitSystem()"><i class="fas fa-sign-out-alt"></i> 退出</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_BASE = ""; 

        document.addEventListener("DOMContentLoaded", () => {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const monthStr = dateStr.slice(0, 7); // 取得 YYYY-MM
            
            document.getElementById('sales-date').value = dateStr;
            document.getElementById('billing-month').value = monthStr;
            
            for(let i=0; i<8; i++) addSalesRow();
            
            // 點擊空白處關閉下拉選單
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-wrapper')) {
                    document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('open'));
                }
            });
        });

        // 頂部導航切換
        function switchSubTab(element, funcId) {
            document.querySelectorAll('.top-pill').forEach(i => i.classList.remove('active'));
            if(!element.parentElement.classList.contains('dropdown-wrapper')) {
                element.classList.add('active');
            }
            const titles = {
                '0': '門市現銷作業',
                '1': '銷貨登記作業',
                '2': '銷貨單查詢'
            };
            if(titles[funcId]) {
                document.getElementById('current-mode-title').innerText = titles[funcId];
                if(funcId === '2') alert("切換至 [銷貨單查詢] 模式");
            }
        }

        function toggleDropdown(wrapper) {
            document.querySelectorAll('.dropdown-wrapper').forEach(d => {
                if(d !== wrapper) d.classList.remove('open');
            });
            wrapper.classList.toggle('open');
        }

        function subAction(actionId) {
            alert("功能 [" + actionId + "] 開發中...");
            event.stopPropagation();
            document.querySelectorAll('.dropdown-wrapper').forEach(d => d.classList.remove('open'));
        }

        // 新增表格行
        function addSalesRow() {
            const tbody = document.getElementById("sales-list");
            const tr = document.createElement("tr");
            const index = tbody.children.length + 1;

            tr.innerHTML = `
                <td style="text-align:center; background:#f8fafc;">${index}</td>
                <td><input type="text" class="p-code" onchange="fetchProductInfo(this)"></td>
                <td><input type="text" class="p-car"></td>
                <td><input type="text" class="p-name"></td>
                <td><input type="number" class="p-qty" value="" onchange="calcRow(this)"></td>
                <td><input type="number" class="p-price" value="" onchange="calcRow(this)"></td>
                <td class="price-col"><input type="text" class="p-total" readonly style="font-weight:bold; color:#059669;"></td>
                <td><input type="text" class="p-note"></td>
                <td><input type="text" class="p-loc"></td>
            `;
            tbody.appendChild(tr);
        }

        // 查詢商品 (API 連接)
        async function fetchProductInfo(input) {
            const code = input.value.trim();
            if (!code) return;
            const row = input.parentElement.parentElement;
            
            try {
                row.querySelector('.p-name').value = "查詢中...";
                const res = await fetch(`${API_BASE}/api/products/${code}`);
                if(res.ok) {
                    const p = await res.json();
                    row.querySelector('.p-name').value = p.name;
                    row.querySelector('.p-car').value = p.carType || '';
                    row.querySelector('.p-loc').value = p.location || '';
                    row.querySelector('.p-price').value = p.price; 
                    
                    const qty = row.querySelector('.p-qty');
                    if(!qty.value) qty.value = 1;
                    
                    calcRow(input);
                    qty.focus(); qty.select();
                } else {
                     row.querySelector('.p-name').value = "無此商品";
                }
            } catch(e) { console.error(e); }
        }

        function calcRow(ele) {
            const row = ele.parentElement.parentElement;
            const qty = parseFloat(row.querySelector('.p-qty').value) || 0;
            const price = parseFloat(row.querySelector('.p-price').value) || 0;
            const total = Math.round(qty * price);
            row.querySelector('.p-total').value = total > 0 ? total : '';
        }

        function changePriceType(select) {
            alert("已切換為 [" + select.options[select.selectedIndex].text + "] 模式");
        }

        // 存檔 (整合新欄位)
        async function saveSales(printMode) {
            const items = [];
            document.querySelectorAll("#sales-list tr").forEach(row => {
                const code = row.querySelector(".p-code").value;
                const name = row.querySelector(".p-name").value;
                
                if (code || name) {
                    items.push({
                        productCode: code || "MANUAL",
                        productName: name,
                        carType: row.querySelector(".p-car").value,
                        quantity: parseInt(row.querySelector(".p-qty").value) || 0,
                        price: parseFloat(row.querySelector(".p-price").value) || 0,
                        amount: parseFloat(row.querySelector(".p-total").value) || 0, // 注意: 這裡是 .value
                        note: row.querySelector(".p-note").value,
                        location: row.querySelector(".p-loc").value
                    });
                }
            });

            if (items.length === 0) { alert("無資料可存檔"); return; }

            // 收集單頭資料 (含新欄位)
            const orderData = {
                date: document.getElementById("sales-date").value,
                billingMonth: document.getElementById("billing-month").value,
                customerCode: document.getElementById("sales-cust").value,
                customerName: document.getElementById("sales-cust-name").value,
                customerAddress: document.getElementById("sales-addr").value,
                creator: "管理員", 
                items: items
            };

            try {
                const res = await fetch(`${API_BASE}/api/sales`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(orderData)
                });

                if(res.ok) {
                    const ret = await res.json();
                    alert("✅ 存檔成功！\n單號：" + ret.orderNumber);
                    if(printMode) window.print();
                    location.reload();
                } else {
                    alert("❌ 存檔失敗，請檢查後端連線");
                }
            } catch(e) { 
                console.error(e);
                alert("⚠️ 連線錯誤：" + e); 
            }
        }

        function clearOrder() {
            if(confirm("確定要刪除整張單據並清空嗎？")) location.reload();
        }

        function editOrder() { alert("進入修改模式"); }
        function exitSystem() { if(confirm("確定要退出系統嗎？")) window.close(); }
    </script>
</body>
</html>