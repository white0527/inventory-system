<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>祥易行動系統</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="祥易查價">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1041/1041888.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: #FFFFFF;
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --ios-gray: #8E8E93;
            --ios-gray-light: #E5E5EA;
            --ios-separator: #C6C6C8;
            --text-primary: #000000;
            --text-secondary: #3C3C4399;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; padding: 0; background-color: var(--ios-bg); color: var(--text-primary); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* === 登入畫面 === */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--ios-bg); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; transition: transform 0.4s ease-in-out;
        }
        .login-logo { font-size: 60px; color: var(--ios-blue); margin-bottom: 20px; }
        .login-title { font-size: 24px; font-weight: 800; margin-bottom: 40px; color: var(--text-primary); }
        .login-input {
            width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 12px;
            border: 1px solid var(--ios-separator); background: var(--ios-card); font-size: 16px; outline: none;
        }
        .login-btn {
            width: 100%; padding: 15px; border-radius: 12px; background: var(--ios-blue);
            color: white; font-weight: bold; font-size: 18px; border: none; cursor: pointer; margin-top: 10px;
        }

        /* === 導航欄 === */
        .nav-bar {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            height: calc(44px + var(--safe-top)); padding-top: var(--safe-top);
            border-bottom: 0.5px solid rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
            position: sticky; top: 0; z-index: 100;
        }
        .nav-title { font-size: 17px; font-weight: 600; }
        
        .content { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 20px; padding-bottom: calc(80px + var(--safe-bottom)); }
        .hidden-for-employee { display: none !important; }

        /* === 搜尋區 === */
        .search-container { display: flex; gap: 10px; align-items: center; }
        .search-wrapper { 
            flex: 1; background-color: var(--ios-gray-light); border-radius: 10px; height: 44px;
            display: flex; align-items: center; padding: 0 12px; transition: 0.2s;
        }
        .search-icon { color: var(--text-secondary); font-size: 16px; margin-right: 8px; }
        .search-input { border: none; background: transparent; font-size: 17px; width: 100%; outline: none; height: 100%; }
        .search-btn {
            background-color: var(--ios-blue); color: white; border: none; border-radius: 10px;
            height: 44px; padding: 0 20px; font-size: 16px; font-weight: 600; cursor: pointer; flex-shrink: 0;
        }
        .search-btn:active { opacity: 0.8; }

        /* === 卡片風格 === */
        .ios-card { background: var(--ios-card); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.02); display: none; margin-bottom: 5px; animation: popIn 0.3s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .product-header { padding: 16px; border-bottom: 0.5px solid var(--ios-separator); }
        .p-name { font-size: 20px; font-weight: 700; margin-bottom: 6px; line-height: 1.3; }
        .p-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .ios-tag { font-size: 13px; font-weight: 500; padding: 4px 10px; border-radius: 6px; background: var(--ios-bg); color: var(--text-secondary); }
        .tag-blue { color: var(--ios-blue); background: rgba(0, 122, 255, 0.1); }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; background: var(--ios-separator); gap: 0.5px; border-bottom: 0.5px solid var(--ios-separator); }
        .info-cell { background: var(--ios-card); padding: 16px; text-align: center; }
        .cell-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .cell-val { font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        .text-red { color: var(--ios-red); }

        .price-list { display: flex; flex-direction: column; }
        .price-item { padding: 16px; display: flex; justify-content: space-between; align-items: center; background: var(--ios-card); position: relative; }
        .price-item:not(:last-child)::after { content: ""; position: absolute; bottom: 0; right: 0; left: 16px; height: 0.5px; background-color: var(--ios-separator); }
        .price-label { font-size: 16px; color: var(--text-primary); }
        .price-val { font-size: 20px; font-weight: 700; }
        .val-green { color: var(--ios-green); }
        .val-blue { color: var(--ios-blue); }
        .val-orange { color: #d97706; }

        .ios-btn { background-color: var(--ios-blue); color: white; border: none; border-radius: 12px; padding: 14px; font-size: 17px; font-weight: 600; width: 100%; margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }

        /* 底部導航 */
        .bottom-nav { height: calc(60px + var(--safe-bottom)); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-top: 0.5px solid var(--ios-separator); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 10px; position: fixed; bottom: 0; width: 100%; z-index: 90; }
        .nav-btn { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: var(--ios-gray); gap: 4px; background: none; border: none; width: 100%; }
        .nav-btn i { font-size: 24px; margin-bottom: 2px; }
        .nav-btn.active { color: var(--ios-blue); }

        .empty-state { text-align: center; color: var(--ios-gray); margin-top: 80px; }
        .empty-icon { font-size: 50px; margin-bottom: 20px; opacity: 0.3; }

        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-item { background: white; padding: 20px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; }
        .menu-item i { font-size: 28px; color: var(--ios-blue); }
        
        .profile-card { background: white; padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .avatar { width: 60px; height: 60px; background: var(--ios-gray-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: var(--ios-gray); }
        .role-tag { background: var(--ios-blue); color: white; padding: 4px 10px; border-radius: 6px; font-size: 13px; margin-top: 5px; display: inline-block; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-logo"><i class="fas fa-cubes"></i></div>
        <div class="login-title">祥易行動系統</div>
        <input type="text" id="login-user" class="login-input" placeholder="帳號">
        <input type="password" id="login-pass" class="login-input" placeholder="密碼">
        <button class="login-btn" onclick="performLogin()">登入</button>
        <div style="margin-top:20px; font-size:13px; color:gray;">預設: admin/8888 或 user/1234</div>
    </div>

    <div id="main-app" style="display:none; height: 100vh; flex-direction: column;">
        
        <div class="nav-bar">
            <div class="nav-title" id="header-title">商品查價</div>
        </div>

        <div id="view-search" class="content" style="display:flex;">
            <div class="search-container">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="keyword" class="search-input" placeholder="輸入代號或名稱" style="text-transform: uppercase;" onkeypress="if(event.key==='Enter') doSearch()">
                </div>
                <button class="search-btn" onclick="doSearch()">查詢</button>
            </div>

            <div id="empty-hint" class="empty-state">
                <i class="fas fa-keyboard empty-icon"></i>
                <p>請輸入關鍵字查詢庫存與價格</p>
            </div>

            <div id="result-card" class="ios-card">
                <div class="product-header">
                    <div class="p-name" id="d-name">--</div>
                    <div class="p-tags">
                        <span class="ios-tag tag-blue" id="d-car">--</span>
                        <span class="ios-tag" id="d-code">--</span>
                    </div>
                </div>
                <div class="info-grid">
                    <div class="info-cell"><div class="cell-label">目前庫存</div><div class="cell-val text-red" id="d-stock">--</div></div>
                    <div class="info-cell"><div class="cell-label">儲位編號</div><div class="cell-val" id="d-loc">--</div></div>
                </div>
                <div class="price-list">
                    <div class="price-item"><span class="price-label">散客價</span><span class="price-val val-green" id="d-price1">--</span></div>
                    <div class="price-item"><span class="price-label">同業價</span><span class="price-val val-blue" id="d-price2">--</span></div>
                    <div class="price-item hidden-for-employee" id="row-cost" onclick="toggleCost()">
                        <span class="price-label"><i class="fas fa-eye-slash"></i> 成本 (點擊顯示)</span>
                        <span class="price-val val-orange" id="d-price3" style="filter: blur(6px);">--</span>
                    </div>
                </div>

                <div id="boss-controls" class="hidden-for-employee" style="padding: 15px; border-top: 1px solid #eee; background: #fff;">
                    <button id="btn-edit" class="ios-btn" style="margin-top:0; background: #000;" onclick="toggleEditMode()">
                        <i class="fas fa-pen"></i> 編輯資料
                    </button>
                    
                    <div id="edit-buttons" style="display:none; gap:10px;">
                        <button class="ios-btn" style="margin-top:0; background: #34C759; flex:1;" onclick="saveProduct()">
                            <i class="fas fa-save"></i> 儲存
                        </button>
                        <button class="ios-btn" style="margin-top:0; background: #8E8E93; flex:1;" onclick="toggleEditMode()">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-menu" class="content" style="display:none;">
            <div class="menu-grid">
                <div class="menu-item hidden-for-employee" onclick="downloadExcel()">
                    <i class="fas fa-file-export" style="color: #107c41;"></i><span>匯出 Excel</span>
                </div>
                <div class="menu-item hidden-for-employee" onclick="triggerImport()">
                    <i class="fas fa-file-import" style="color: #107c41;"></i><span>匯入 Excel</span>
                </div>
                <input type="file" id="excel-input" accept=".xlsx" style="display: none;" onchange="uploadExcel(this)">

                <div class="menu-item" onclick="alert('查看庫存清單')"><i class="fas fa-list"></i><span>庫存查詢</span></div>
                <div class="menu-item hidden-for-employee" onclick="alert('系統設定')"><i class="fas fa-cog"></i><span>系統設定</span></div>
            </div>
            <div id="employee-msg" class="hidden-for-employee" style="text-align:center; color:gray; margin-top:50px; display:none;">
                <i class="fas fa-lock" style="font-size:40px; margin-bottom:10px;"></i><br>進階功能僅限管理員使用
            </div>
        </div>

        <div id="view-profile" class="content" style="display:none;">
            <div class="profile-card">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div><div style="font-size:20px; font-weight:bold;" id="user-name">訪客</div><div class="role-tag" id="user-role">未登入</div></div>
            </div>
            <button class="ios-btn" style="background:var(--ios-red);" onclick="logout()">登出系統</button>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('view-search', '商品查價', this)"><i class="fas fa-search"></i>查價</button>
            <button class="nav-btn" onclick="switchTab('view-menu', '功能選單', this)"><i class="fas fa-th-large"></i>功能</button>
            <button class="nav-btn" onclick="switchTab('view-profile', '我的帳號', this)"><i class="fas fa-user"></i>我的</button>
        </div>
    </div>

    <script>
        // ========================================================
        // ★★★ 【重要】請填入您的 Render 網址 (不要有 /api) ★★★
        // ========================================================
        const API_BASE_URL = "https://xiangyi-system.onrender.com"; 

        let currentUser = null;

        // === 1. 登入系統 ===
        async function performLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            const btn = document.querySelector('.login-btn');
            
            btn.innerText = "連線中...";
            btn.style.background = "#666";
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await response.json();

                if (data.success) {
                    loginSuccess({ name: data.name, role: data.role });
                } else {
                    alert('帳號或密碼錯誤！');
                }
            } catch (error) {
                alert("連線錯誤：\n" + error.message);
                // 離線測試用
                if(u === 'admin') loginSuccess({ name: '老闆(測試)', role: 'admin' });
            } finally {
                btn.innerText = "登入";
                btn.style.background = "#007AFF";
            }
        }

        function loginSuccess(user) {
            currentUser = user;
            document.getElementById('user-name').innerText = user.name;
            document.getElementById('user-role').innerText = user.role === 'admin' ? '管理員 (Boss)' : '一般員工';
            document.getElementById('user-role').style.background = user.role === 'admin' ? '#007AFF' : '#8E8E93';

            const adminElements = document.querySelectorAll('.hidden-for-employee');
            const empMsg = document.getElementById('employee-msg');

            if (user.role === 'employee') {
                adminElements.forEach(el => el.style.display = 'none');
                if(empMsg) empMsg.style.display = 'block';
            } else {
                adminElements.forEach(el => {
                    if(el.classList.contains('menu-item') || el.classList.contains('price-item')) el.style.display = 'flex';
                    else if (el.tagName === 'BUTTON') el.style.display = 'flex';
                    else el.style.display = 'block';
                });
                if(empMsg) empMsg.style.display = 'none';
            }
            document.getElementById('login-screen').style.transform = 'translateY(-100%)';
            document.getElementById('main-app').style.display = 'flex';
        }

        function logout() { if(confirm('確定要登出嗎？')) window.location.reload(); }

        // === 2. 查價功能 ===
        async function doSearch() {
            const val = document.getElementById('keyword').value.trim();
            if(!val) return;

            document.getElementById('keyword').blur();

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/search?keyword=${encodeURIComponent(val)}`);
                let data = null;
                if (response.ok) {
                    data = await response.json();
                }

                if (!data) {
                    alert("查無此商品資料");
                    return;
                }

                // 填入資料
                document.getElementById('empty-hint').style.display = 'none';
                document.getElementById('result-card').style.display = 'block';
                
                document.getElementById('d-name').innerText = data.name;
                document.getElementById('d-code').innerText = data.code;
                document.getElementById('d-car').innerText = data.carModel || data.car;
                document.getElementById('d-stock').innerText = data.stock;
                document.getElementById('d-loc').innerText = data.location || data.loc;
                document.getElementById('d-price1').innerText = "$" + (data.priceRetail || 0);
                document.getElementById('d-price2').innerText = "$" + (data.pricePeer || 0);
                document.getElementById('d-price3').innerText = "$" + (data.priceCost || 0);
                
                // 重置編輯狀態
                isEditing = false;
                document.getElementById('btn-edit').style.display = 'flex';
                document.getElementById('edit-buttons').style.display = 'none';
                document.getElementById('d-price3').style.filter = 'blur(6px)';

            } catch (e) {
                console.error(e);
                alert("查詢發生錯誤");
            }
        }

        function toggleCost() {
            const el = document.getElementById('d-price3');
            el.style.filter = el.style.filter === 'none' ? 'blur(6px)' : 'none';
        }

        // === 3. 老闆編輯功能 ===
        let isEditing = false;
        let originalData = {};

        function toggleEditMode() {
            if (!currentUser || currentUser.role !== 'admin') return;

            isEditing = !isEditing;
            const btnEdit = document.getElementById('btn-edit');
            const editGroup = document.getElementById('edit-buttons');
            const fields = ['d-stock', 'd-loc', 'd-price1', 'd-price2', 'd-price3'];
            const keys = ['stock', 'location', 'priceRetail', 'pricePeer', 'priceCost'];

            if (isEditing) {
                btnEdit.style.display = 'none';
                editGroup.style.display = 'flex';
                fields.forEach((id, index) => {
                    const el = document.getElementById(id);
                    const val = el.innerText.replace('$', '').replace(/,/g, '');
                    originalData[id] = val;
                    el.innerHTML = `<input type="text" id="input-${keys[index]}" value="${val}" style="width:100%; font-size:18px; text-align:center; border:1px solid #ccc; border-radius:5px; color:blue;">`;
                    if(id === 'd-price3') el.style.filter = 'none';
                });
            } else {
                btnEdit.style.display = 'flex';
                editGroup.style.display = 'none';
                fields.forEach(id => {
                    document.getElementById(id).innerText = (id.includes('price') ? '$' : '') + originalData[id];
                    if(id === 'd-price3') document.getElementById(id).style.filter = 'blur(6px)';
                });
            }
        }

        async function saveProduct() {
            const code = document.getElementById('d-code').innerText;
            const payload = {
                code: code,
                stock: document.getElementById('input-stock').value,
                location: document.getElementById('input-location').value,
                priceRetail: document.getElementById('input-priceRetail').value,
                pricePeer: document.getElementById('input-pricePeer').value,
                priceCost: document.getElementById('input-priceCost').value
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/products/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (result.success) {
                    alert("修改成功！");
                    isEditing = false;
                    document.getElementById('btn-edit').style.display = 'flex';
                    document.getElementById('edit-buttons').style.display = 'none';
                    document.getElementById('d-stock').innerText = payload.stock;
                    document.getElementById('d-loc').innerText = payload.location;
                    document.getElementById('d-price1').innerText = "$" + payload.priceRetail;
                    document.getElementById('d-price2').innerText = "$" + payload.pricePeer;
                    document.getElementById('d-price3').innerText = "$" + payload.priceCost;
                    document.getElementById('d-price3').style.filter = 'blur(6px)';
                } else {
                    alert("修改失敗：" + result.message);
                }
            } catch (e) {
                alert("連線錯誤，無法儲存");
            }
        }

        // === 4. Excel 功能 ===
        async function downloadExcel() {
            if (!confirm("確定要匯出所有商品資料嗎？")) return;
            try {
                alert("正在準備檔案，請稍候...");
                const response = await fetch(`${API_BASE_URL}/api/excel/export`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `祥易庫存表_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    alert("匯出失敗");
                }
            } catch (e) {
                alert("匯出錯誤");
            }
        }

        function triggerImport() { document.getElementById('excel-input').click(); }

        async function uploadExcel(input) {
            if (input.files.length === 0) return;
            const formData = new FormData();
            formData.append("file", input.files[0]);
            alert("正在上傳並處理，請稍候...");

            try {
                const response = await fetch(`${API_BASE_URL}/api/excel/import`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    alert("✅ " + result.message);
                    location.reload();
                } else {
                    alert("❌ 失敗：" + result.message);
                }
            } catch (e) {
                alert("上傳錯誤");
            }
            input.value = '';
        }

        // === UI 切換 ===
        function switchTab(viewId, title, btn) {
            document.querySelectorAll('.content').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'flex';
            document.getElementById('header-title').innerText = title;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>